package unisolar.api.cli;

import org.springframework.boot.CommandLineRunner;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;
import unisolar.api.controller.UserController;
import unisolar.api.domain.dto.userDTO.*;
import unisolar.api.domain.entity.*;
import unisolar.api.search.FeatureSearchTree;
import unisolar.api.service.ChatbotService;
import unisolar.api.service.FeatureSearchService;
import unisolar.api.service.MaintenanceService;

import java.text.DecimalFormat;
import java.text.Normalizer;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Component
public class UniSolarCLI implements CommandLineRunner {
    private final Scanner scanner;
    private final AuthenticationManager authenticationManager;
    private final UserController userController;
    private final ChatbotService chatbotService;
    private Authentication currentAuthentication;
    private MaintenanceService maintenanceService;

    private FeatureSearchService featureSearchService;

    private final DecimalFormat df = new DecimalFormat("#,##0.00");
    private static Map<String, String> respostas;

    public UniSolarCLI(AuthenticationManager authenticationManager,
                       UserController userController,
                       ChatbotService chatbotService,
                       FeatureSearchService featureSearchService) {
        this.scanner = new Scanner(System.in);
        this.authenticationManager = authenticationManager;
        this.userController = userController;
        this.chatbotService = chatbotService;
        this.featureSearchService = featureSearchService;
    }

    @Override
    public void run(String... args) {
        boolean running = true;
        while (running) {
            if (currentAuthentication == null) {
                showLoginMenu();
            } else {
                running = showMainMenu();
            }
        }
        scanner.close();
        System.out.println("\n=====================================");
        System.out.println("    Obrigado por usar o UniSolar!    ");
        System.out.println("          At√© logo! üëã               ");
        System.out.println("=====================================");
    }

    private void showLoginMenu() {
        System.out.println("\n=========== UniSolar üåû =============");
        System.out.println("      Energia que transforma vidas      ");
        System.out.println("=====================================");

        int choice = -1;
        while (choice != 1 && choice != 2) {
            System.out.println("1. Login üîë");
            System.out.println("2. Cadastro üìù");
            System.out.print("Escolha uma op√ß√£o: ");

            if (scanner.hasNextInt()) {
                choice = scanner.nextInt();
                scanner.nextLine(); // consume newline
            } else {
                scanner.nextLine(); // consume invalid input
                choice = -1; // invalid choice
            }

            if (choice == 1) {
                doLogin();
            } else if (choice == 2) {
                doRegister();
            } else {
                System.out.println("\n[Erro ‚ùå] Op√ß√£o inv√°lida! Tente novamente.");
            }

        }
    }


    private boolean showMainMenu() {
        System.out.println("\n=========== Menu Principal ===========");
        System.out.println("1. Buscar üîé");
        System.out.println("2. Dashboard üìä");
        System.out.println("3. Perfil do Usu√°rio üë§");
        System.out.println("4. Chat com SolarIA ü§ñ");
        System.out.println("5. Alterar Senha üîí");
        System.out.println("6. Logout üö∂‚Äç‚ôÇÔ∏è");
        System.out.print("Escolha uma op√ß√£o: ");

        int choice = scanner.nextInt();
        scanner.nextLine(); // consume newline

        switch (choice) {
            case 1:
                showFeatureSearch();
                return true;
            case 2:
                showDashboard();
                return true;
            case 3:
                showUserProfile();
                return true;
            case 4:
                startChat();
                return true;
            case 5:
                changePassword();
                return true;
            case 6:
                currentAuthentication = null;
                System.out.println("\n[Sucesso ‚úÖ] Logout realizado com sucesso!");
                return false; // Termina o loop para for√ßar logout
            default:
                System.out.println("\n[Erro ‚ùå] Op√ß√£o inv√°lida! Tente novamente.");
                return true;
        }
    }

    private void doLogin() {
        System.out.println("\n=========== Login üîë ===========");
        System.out.print("Username: ");
        String username = scanner.nextLine();
        System.out.print("Senha: ");
        String password = scanner.nextLine();

        try {
            var authenticationToken = new UsernamePasswordAuthenticationToken(username, password);
            currentAuthentication = authenticationManager.authenticate(authenticationToken);
            System.out.println("\n[Sucesso ‚úÖ] Login realizado com sucesso!");
        } catch (Exception e) {
            System.out.println("\n[Erro ‚ùå] Credenciais inv√°lidas. Tente novamente.");
        }
    }

    private void doRegister() {
        System.out.println("\n=========== Cadastro üìù ===========");
        System.out.print("Nome: ");
        String name = scanner.nextLine();
        System.out.print("Email: ");
        String email = scanner.nextLine();
        System.out.print("Username: ");
        String username = scanner.nextLine();
        System.out.print("Senha: ");
        String password = scanner.nextLine();

        try {
            UserCreateDTO newUser = new UserCreateDTO(username, password, name, email);
            ResponseEntity<UserDetailDTO> response = userController.createUser(newUser, UriComponentsBuilder.newInstance());
            if (response.getStatusCode().is2xxSuccessful()) {
                System.out.println("\n[Sucesso ‚úÖ] Cadastro realizado com sucesso! Por favor, fa√ßa login.");
            }
        } catch (Exception e) {
            System.out.println("\n[Erro ‚ùå] Ocorreu um erro no cadastro: " + e.getMessage());
        }
    }

    private void showDashboard() {

        System.out.println("\n=========== Dashboard üìä ===========");

        ResponseEntity<UserDetailDTO> userResponse = userController.getCurrentUser(currentAuthentication);
        if (userResponse.getStatusCode().is2xxSuccessful() && userResponse.getBody() != null) {
            UserDetailDTO user = userResponse.getBody();
            System.out.println("üëã Ol√°, " + user.name() + "!");

            // Buscar detalhes da instala√ß√£o do usu√°rio
            Installation installation = getInstallationDetails(user.id());

            if (installation != null) {
                int option;
                do {
                    System.out.println("\nMenu Principal");
                    System.out.println("‚ïê".repeat(45));
                    System.out.println("1Ô∏è - Status do Sistema üì°");
                    System.out.println("2Ô∏è - Economia üí∞");
                    System.out.println("3Ô∏è - Previs√£o üîÆ");
                    System.out.println("4Ô∏è - Manuten√ß√£o üõ†Ô∏è");
                    System.out.println("5Ô∏è - O Que a SolarIA Planejou para Voc√™ Hoje ü§ñ");
                    System.out.println("6Ô∏è - Dicas para Economia de Energia üå±");
                    System.out.println("7Ô∏è - Voltar üîô");
                    System.out.print("\nEscolha uma op√ß√£o (1-7): ");

                    while (!scanner.hasNextInt()) {
                        System.out.println("‚ö†Ô∏è  Entrada inv√°lida. Por favor, insira um n√∫mero entre 1 e 7.");
                        System.out.print("Escolha uma op√ß√£o (1-7): ");
                        scanner.next();
                    }
                    option = scanner.nextInt();
                    scanner.nextLine();

                    System.out.println("\n" + "‚ïê".repeat(45));

                    switch (option) {
                        case 1 -> {
                            mostrarStatus(installation);
                        }
                        case 2 -> {
                            mostrarEconomia(installation);
                        }
                        case 3 -> {
                            mostrarPrevisaoEnergia(installation);
                        }
                        case 4 -> {
                            mostrarManutencao(installation);
                        }
                        case 5 -> {
                            mostrarDecisoesDaIA(installation);
                        }
                        case 6 -> {
                            mostrarDicas();
                        }
                        case 7 -> System.out.println("üîô Voltando ao menu principal...");
                        default -> System.out.println("‚ö†Ô∏è  Op√ß√£o inv√°lida. Tente novamente.");
                    }

                    if (option != 7) {
                        System.out.println("\nPressione ENTER para retornar ao menu...");
                        scanner.nextLine();
                    }

                } while (option != 7);
            } else {
                System.out.println("‚ö†Ô∏è  Nenhuma instala√ß√£o encontrada. Verifique suas configura√ß√µes.");
            }
        } else {
            System.out.println("‚ö†Ô∏è  N√£o foi poss√≠vel recuperar os detalhes do usu√°rio.");
        }

        System.out.println("\n‚úÖ Saindo do Dashboard. At√© logo!\n");
    }

    private void showFeatureSearch() {
        System.out.println("\n=========== Busca de Funcionalidades üîç ===========");
        System.out.println("Digite 'voltar' para retornar ao menu principal");

        while (true) {
            System.out.print("\nBuscar funcionalidade: ");
            String query = scanner.nextLine().trim();

            if (query.equalsIgnoreCase("voltar")) {
                break;
            }

            if (query.length() < 2) {
                System.out.println("\n‚ö†Ô∏è  Digite pelo menos 2 caracteres para buscar");
                continue;
            }

            List<FeatureSearchTree.Feature> results = featureSearchService.searchFeatures(query);

            if (results.isEmpty()) {
                System.out.println("\n‚ùå Nenhuma funcionalidade encontrada para '" + query + "'");
                continue;
            }

            System.out.println("\n=== Funcionalidades Encontradas ===");
            results.forEach(feature -> {
                System.out.println("\n" + feature);
            });
        }
    }

    private void mostrarDecisoesDaIA(Installation installation) {
        if (installation != null) {
            System.out.println("\n=== O Que a SolarIA planejou para voc√™ hoje? ===");

            double solarGenerationMorning = 100.0 + (Math.random() * 50.0);  // Gera√ß√£o solar maior pela manh√£
            double batteryChargeMorning = 100.0;  // A bateria carrega para 100% durante o dia
            double batteryUsageMorning = solarGenerationMorning * 0.5;  // Usa 50% da gera√ß√£o solar para carregar a bateria
            double solarGenerationAfternoon = 50.0 + (Math.random() * 30.0);  // Gera√ß√£o solar menor devido √†s nuvens
            double batteryConsumptionNight = 20.0 + (Math.random() * 10.0);  // A bateria √© utilizada para carregar os aparelhos essenciais
            double batteryDischargeAmount = 0.2 + (Math.random() * 0.3) * 100;  // Descarregar a bateria durante hor√°rios de pico (tarifa mais alta)

            System.out.println("\nüåÖ Manh√£ Ensolarada:");
            System.out.println("Gera√ß√£o Solar: " + df.format(solarGenerationMorning) + " kWh");
            System.out.println("Bateria Carregada: " + df.format(batteryUsageMorning) + " kWh");
            if (batteryChargeMorning > 90) {
                System.out.println("üí° Decis√£o da IA: Usar energia solar ao m√°ximo pela manh√£.");
            } else {
                System.out.println("üí° Decis√£o da IA: Priorizar o uso da bateria para garantir energia √† noite.");
            }

            System.out.println("\nüå•Ô∏è Tarde Nublada:");
            System.out.println("Gera√ß√£o Solar: " + df.format(solarGenerationAfternoon) + " kWh");
            if (solarGenerationAfternoon < 60) {
                System.out.println("üí° Decis√£o da IA: Usar energia solar sem utilizar a bateria.");
            } else {
                System.out.println("üí° Decis√£o da IA: Reduzir o uso da bateria para preservar energia para a noite.");
            }

            System.out.println("\nüåô Noite:");
            System.out.println("Consumo da Bateria: " + df.format(batteryConsumptionNight) + " kWh üîã");
            if (batteryConsumptionNight > 20) {
                System.out.println("üí° Decis√£o da IA: Aumentar a utiliza√ß√£o da bateria para garantir energia durante a noite.");
            } else {
                System.out.println("üí° Decis√£o da IA: Otimizar o consumo de energia para evitar descarregar a bateria demais.");
            }

            System.out.println("\nüåû Dia Seguinte com Tarifas Mais Altas:");
            System.out.println("Descarregamento da Bateria: " + df.format(batteryDischargeAmount) + "%");
            double savingsFromBatteryDischarge = batteryDischargeAmount * 0.75;  // Suposi√ß√£o de economia de 75%
            System.out.println("üí° Decis√£o da IA: Descarregar mais bateria durante hor√°rios de pico para economizar com tarifas altas.");
            System.out.println("Economia Estimada: R$ " + df.format(savingsFromBatteryDischarge) + " üí∞");
        }
    }

    private Installation getInstallationDetails(Long userId) {

        ResponseEntity<Installation> installationResponse = userController.getUserInstallation(userId);
        if (installationResponse.getStatusCode().is2xxSuccessful() && installationResponse.getBody() != null) {
            return installationResponse.getBody();
        } else {
            System.out.println("\n[Erro ‚ùå] N√£o foi poss√≠vel carregar os dados de instala√ß√£o.");
            return null;
        }
    }

    private void mostrarStatus(Installation installation) {
        if (installation != null) {
            System.out.println("\n=== Status do Sistema ===");

            boolean usandoEnergiaSolar = installation.getSolarPanels().size() > 0; // Verifica se h√° pain√©is solares
            System.out.println("\nFonte de Energia Atual: " + (usandoEnergiaSolar ? "Solar ‚òÄÔ∏è" : "Rede El√©trica ‚ö°"));

            Battery battery = installation.getBattery();
            int batteryCharge = battery != null ? (int) battery.getCurrentCharge() : 0;
            String statusBateria = batteryCharge > 50 ? "Carregada üëç" : "Baixa ‚ö†Ô∏è";
            String batteryStatus = battery != null ? battery.getHealth() : "Desconhecido ‚ùì";

            System.out.println("\nBateria:");
            System.out.println("N√≠vel: " + batteryCharge + "% " + gerarBarraProgresso(batteryCharge));
            System.out.println("Status: " + statusBateria + " (" + batteryStatus + ")");

            List<SolarPanel> panels = installation.getSolarPanels();
            String statusPaineis = panels.isEmpty() ? "Sem Pain√©is üö´" : "Operacional üåû";
            System.out.println("\nPain√©is Solares:");
            for (SolarPanel panel : panels) {
                String panelStatus = panel.getStatus();
                System.out.println("Painel Solar " + panel.getId() + ": " + panelStatus);
            }
            System.out.println("Status: " + statusPaineis);
        }
    }

    private void mostrarEconomia(Installation installation) {
        if (installation != null) {
            System.out.println("\n=== Economia ===");

            double totalSolarConsumption = Math.random() * 50 + 20;  // Consumo solar entre 20 e 70 kWh
            double totalGridConsumption = Math.random() * 50 + 10;   // Consumo da rede entre 10 e 60 kWh
            double totalBatteryConsumption = Math.random() * 30 + 5;  // Consumo de bateria entre 5 e 35 kWh

            double totalConsumption = totalSolarConsumption + totalGridConsumption + totalBatteryConsumption;
            double economiaHoje = totalSolarConsumption * 0.25; // Exemplo de economia (ajuste conforme necess√°rio)
            double economiaMes = totalSolarConsumption * 7.5;   // Exemplo de economia mensal (ajuste conforme necess√°rio)
            double projecaoAnual = economiaMes * 12;             // Proje√ß√£o anual

            System.out.println("Consumo Total: " + df.format(totalConsumption) + " kWh");
            System.out.println("Consumo Solar: " + df.format(totalSolarConsumption) + " kWh üåû");
            System.out.println("Consumo da Rede: " + df.format(totalGridConsumption) + " kWh ‚ö°");
            System.out.println("Consumo da Bateria: " + df.format(totalBatteryConsumption) + " kWh üîã");

            System.out.println("\nEconomia Hoje: R$ " + df.format(economiaHoje) + " üí∞");
            System.out.println("Economia do M√™s: R$ " + df.format(economiaMes) + " üíµ");
            System.out.println("Proje√ß√£o Anual: R$ " + df.format(projecaoAnual) + " üìä");
        }
    }

    private void showUserProfile() {
        ResponseEntity<UserDetailDTO> response = userController.getCurrentUser(currentAuthentication);
        if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
            UserDetailDTO user = response.getBody();
            System.out.println("\n=========== Perfil do Usu√°rio üë§ ===========");
            System.out.println("Nome: " + user.name());
            System.out.println("Email: " + user.email());
            System.out.println("Username: " + user.username());

            System.out.println("\n1. Atualizar perfil ‚úèÔ∏è");
            System.out.println("2. Deletar perfil üóëÔ∏è");
            System.out.println("3. Voltar üîô");
            System.out.print("Escolha uma op√ß√£o: ");

            int choice = scanner.nextInt();
            scanner.nextLine();

            switch (choice) {
                case 1:
                    updateProfile(user);
                    break;
                case 2:
                    deleteProfile(user);
                    break;
                case 3:
                    return;
                default:
                    System.out.println("\n[Erro ‚ùå] Op√ß√£o inv√°lida! Tente novamente.");
            }
        }
    }

    private void updateProfile(UserDetailDTO currentUser) {
        System.out.println("\n=========== Atualizar Perfil ‚úèÔ∏è ===========");
        System.out.println("Deixe em branco para manter o valor atual");

        System.out.print("Novo nome (" + currentUser.name() + "): ");
        String name = scanner.nextLine();

        System.out.print("Novo email (" + currentUser.email() + "): ");
        String email = scanner.nextLine();

        System.out.print("Novo username (" + currentUser.username() + "): ");
        String username = scanner.nextLine();

        try {
            UserUpdateDTO updateData = new UserUpdateDTO(
                    currentUser.id(),
                    username.isEmpty() ? null : username,
                    name.isEmpty() ? null : name,
                    email.isEmpty() ? null : email
            );
            ResponseEntity response = userController.updateUser(updateData);
            if (response.getStatusCode().is2xxSuccessful()) {
                System.out.println("\n[Sucesso ‚úÖ] Perfil atualizado com sucesso!");
            }
        } catch (Exception e) {
            System.out.println("\n[Erro ‚ùå] Ocorreu um erro ao atualizar perfil: " + e.getMessage());
        }
    }

    private void changePassword() {
        ResponseEntity<UserDetailDTO> response = userController.getCurrentUser(currentAuthentication);
        if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
            System.out.print("\nSenha atual: ");
            String oldPassword = scanner.nextLine();
            System.out.print("Nova senha: ");
            String newPassword = scanner.nextLine();

            try {
                ChangePasswordDTO changePasswordDTO = new ChangePasswordDTO(oldPassword, newPassword);
                ResponseEntity<String> changeResponse = userController.changePassword(response.getBody().id(), changePasswordDTO);
                if (changeResponse.getStatusCode().is2xxSuccessful()) {
                    System.out.println("\n[Sucesso ‚úÖ] Senha alterada com sucesso!");
                    currentAuthentication = null; // Force re-login
                    System.out.println("Por favor, fa√ßa login novamente com sua nova senha.");
                } else {
                    System.out.println("\n[Erro ‚ùå] N√£o foi poss√≠vel alterar a senha: " + changeResponse.getBody());
                }
            } catch (Exception e) {
                System.out.println("\n[Erro ‚ùå] Ocorreu um erro ao alterar senha: " + e.getMessage());
            }
        }
    }

    private void deleteProfile(UserDetailDTO currentUser) {
        System.out.println("\n=========== Deletar Perfil üóëÔ∏è ===========");
        System.out.print("Tem certeza que deseja deletar seu perfil? (s/n): ");
        String confirmation = scanner.nextLine();

        if (confirmation.equalsIgnoreCase("s")) {
            try {
                ResponseEntity<String> response = userController.deactivateUser(currentUser.id());
                if (response.getStatusCode().is2xxSuccessful()) {
                    System.out.println("\n[Sucesso ‚úÖ] Perfil deletado com sucesso. Voc√™ ser√° desconectado.");
                    currentAuthentication = null; // For√ßar logout ap√≥s exclus√£o do perfil
                } else {
                    System.out.println("\n[Erro ‚ùå] N√£o foi poss√≠vel deletar o perfil: " + response.getBody());
                }
            } catch (Exception e) {
                System.out.println("\n[Erro ‚ùå] Ocorreu um erro ao deletar perfil: " + e.getMessage());
            }
        } else {
            System.out.println("\n[Info ‚ÑπÔ∏è] A√ß√£o cancelada pelo usu√°rio.");
        }
    }

    private String gerarBarraProgresso(int porcentagem) {
        int barSize = 20;
        int preenchido = (int) ((porcentagem / 100.0) * barSize);
        StringBuilder barra = new StringBuilder("[");

        for (int i = 0; i < barSize; i++) {
            barra.append(i < preenchido ? "‚ñà" : "‚ñë");
        }
        barra.append("]");
        return barra.toString();
    }

    private void mostrarManutencao(Installation installation) {
        if (installation != null) {
            System.out.println("\n=== Manuten√ß√£o do Sistema ===");

            Random rand = new Random();

            for (SolarPanel panel : installation.getSolarPanels()) {
                int panelAge = rand.nextInt(10) + 1;  // Idade do painel (em anos)
                double efficiency = rand.nextDouble() * 100;  // Efici√™ncia atual do painel
                boolean needMaintenance = efficiency < 85 || panelAge > 5 || rand.nextDouble() < 0.2;  // Condi√ß√µes de manuten√ß√£o

                System.out.println("Painel Solar " + panel.getId() + " (Idade: " + panelAge + " anos, Efici√™ncia: " + df.format(efficiency) + "%):");
                if (needMaintenance) {
                    System.out.println("    ‚ö†Ô∏è Precisa de manuten√ß√£o (Efici√™ncia baixa ou desgaste excessivo).");
                } else {
                    System.out.println("    üëç Em bom estado.");
                }
            }

            // Manuten√ß√£o das baterias
            Battery battery = installation.getBattery();
            if (battery != null) {
                int batteryAge = rand.nextInt(10) + 1;  // Idade da bateria (em anos)
                double batteryHealth = rand.nextDouble() * 100;  // Estado de sa√∫de da bateria
                boolean needsMaintenance = batteryHealth < 75 || batteryAge > 5 || rand.nextDouble() < 0.15;  // Condi√ß√µes de manuten√ß√£o

                System.out.println("\nBateria (Idade: " + batteryAge + " anos, Sa√∫de: " + df.format(batteryHealth) + "%):");
                if (needsMaintenance) {
                    System.out.println("    ‚ö†Ô∏è A bateria precisa de manuten√ß√£o (Desgaste ou sa√∫de comprometida).");
                } else {
                    System.out.println("    üëç Bateria em bom estado.");
                }
            }
        }
    }


    private void mostrarDicas() {
        System.out.println("\n=== Dicas para Economia de Energia ===");
        System.out.println("1. Aproveite ao m√°ximo a energia solar durante o dia.");
        System.out.println("2. Evite picos de consumo de energia, distribuindo o uso de aparelhos ao longo do dia.");
        System.out.println("3. Realize a manuten√ß√£o regular dos seus pain√©is solares para garantir alta efici√™ncia.");
        System.out.println("4. Considere melhorar a efici√™ncia energ√©tica da sua casa com melhores eletrodom√©sticos.");
    }

    private void mostrarPrevisaoEnergia(Installation installation) {
        if (installation != null) {
            System.out.println("\n=== Previs√£o de Energia ===");

            Random rand = new Random();

            // Simulando a previs√£o de gera√ß√£o solar e consumo considerando variabilidade clim√°tica
            double geraSolarDia = rand.nextDouble() * 30 + 20;  // Gera√ß√£o solar por hora (kWh), com varia√ß√£o clim√°tica
            double consomeEnergia = rand.nextDouble() * 20 + 10;  // Consumo de energia por hora (kWh), variando de acordo com o uso

            // Estimando a produ√ß√£o e consumo para as pr√≥ximas 24 horas
            double totalSolarGenerated = geraSolarDia * 24;  // Gera√ß√£o solar nas pr√≥ximas 24 horas
            double totalEnergyConsumed = consomeEnergia * 24;  // Consumo de energia nas pr√≥ximas 24 horas

            // Economia estimada usando energia solar
            double economiaEsperada = (totalSolarGenerated - totalEnergyConsumed) > 0
                    ? (totalSolarGenerated - totalEnergyConsumed)
                    : 0;  // Economia se houver gera√ß√£o suficiente

            System.out.println("Previs√£o de energia gerada nas pr√≥ximas 24 horas: " + df.format(totalSolarGenerated) + " kWh");
            System.out.println("Previs√£o de energia consumida nas pr√≥ximas 24 horas: " + df.format(totalEnergyConsumed) + " kWh");
            System.out.println("Economia esperada (se voc√™ usar energia solar ao inv√©s de rede el√©trica): " + df.format(economiaEsperada) + " kWh");

            // Condi√ß√µes clim√°ticas e variabilidade
            String weatherCondition = rand.nextDouble() < 0.5 ? "Ensolarado ‚òÄÔ∏è" : "Nublado ‚òÅÔ∏è";
            System.out.println("Condi√ß√£o clim√°tica prevista: " + weatherCondition);

            if ("Nublado ‚òÅÔ∏è".equals(weatherCondition)) {
                System.out.println("    ‚õÖ Gera√ß√£o solar ser√° reduzida em 30% devido ao clima nublado.");
                totalSolarGenerated *= 0.7;  // Ajusta a gera√ß√£o solar
            }
        }
    }

    private void initializeResponses() {
        respostas = new HashMap<>();
        ResponseEntity<UserDetailDTO> userResponse = userController.getCurrentUser(currentAuthentication);
        UserDetailDTO user = userResponse.getBody();

        // Boas-vindas e Apresenta√ß√£o
        respostas.put("ol√°", "Ol√° " + user.name() + "! üëã Como posso ajudar voc√™ hoje? Estou aqui para responder suas d√∫vidas sobre energia solar e mostrar como voc√™ est√° economizando! ‚òÄÔ∏è");
        respostas.put("bom dia", "Bom dia " + user.name() + "! ‚òÄÔ∏è O dia est√° perfeito para energia solar! Sua gera√ß√£o j√° est√° 15% acima da m√©dia. Posso ajudar com algo espec√≠fico?");
        respostas.put("boa tarde", "Boa tarde " + user.name() + "! üå§Ô∏è Seus pain√©is est√£o funcionando a todo vapor, j√° geraram 12.5 kWh hoje! Como posso ajudar?");
        respostas.put("boa noite", "Boa noite " + user.name() + "! üåô Sua bateria est√° com 90% de carga, perfeita para o consumo noturno. Precisa de alguma informa√ß√£o?");
        respostas.put("como funciona a solaria", "ü§ñ Eu sou a SolarIA, a intelig√™ncia artificial por tr√°s do sistema de energia solar da UniSolar! \nEu trabalho de forma integrada para otimizar o uso da energia solar em sua resid√™ncia. Aqui est√° como eu funciono:\n\n1. **Pain√©is Solares**: Eu monitoro os pain√©is solares instalados no seu telhado ou outro local estrat√©gico, capturando a energia solar durante o dia.\n2. **Bateria de Carro El√©trico Reutilizada**: Eu tamb√©m gerencio a bateria que armazena a energia solar gerada para uso posterior, como √† noite ou em dias nublados.\n3. **Minha Intelig√™ncia Artificial**: Eu analiso os dados em tempo real, como previs√£o do tempo, tarifas de energia e o consumo di√°rio, para otimizar a utiliza√ß√£o da energia solar e das baterias.");

                // Status Atual e Monitoramento
        respostas.put("como est√° meu sistema agora", String.format("üìä Status atual (%s):\nGera√ß√£o Solar: 2.8 kWh/h\nCarga da Bateria: 85%%\nConsumo Atual: 1.2 kWh\nEconomia Hoje: R$ 15,40",
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("HH:mm"))));
        respostas.put("qual minha economia hoje", "üí∞ Economia do dia:\nEconomia Atual: R$ 22,50\nPrevis√£o at√© final do dia: R$ 35,80\nVoc√™ est√° 20% acima da meta di√°ria! Continue assim! üéØ");
        respostas.put("mostre o status da bateria", "üîã Status da Bateria:\nN√≠vel: 85%\nSa√∫de: 96%\nTemperatura: 25¬∞C\nAutonomia: 6.5 horas\nPr√≥xima recarga estimada: 22:30");
        respostas.put("como est√£o meus pain√©is", "‚òÄÔ∏è Status dos Pain√©is:\nEfici√™ncia: 98%\nGera√ß√£o Atual: 2.8 kWh\nLimpeza: Boa\n√öltima Manuten√ß√£o: 15 dias atr√°s\nPr√≥xima limpeza recomendada: 7 dias");

        // An√°lises e Previs√µes
        respostas.put("como foi meu consumo essa semana", "üìà An√°lise Semanal:\nConsumo Total: 125 kWh\nEconomia: R$ 180,50\nRedu√ß√£o vs semana anterior: 15%\nMelhor dia: Ter√ßa (32 kWh)\nDica: Seus hor√°rios de consumo est√£o √≥timos! üåü");
        respostas.put("previs√£o para amanh√£", "üîÆ Previs√£o para amanh√£:\nClima: Ensolarado ‚òÄÔ∏è\nGera√ß√£o Estimada: 18.5 kWh\nMelhores hor√°rios: 9h-15h\nEconomia Prevista: R$ 28,90\nDica: Aproveite para usar eletrodom√©sticos entre 10h-14h!");
        respostas.put("mostre minha meta mensal", "üéØ Acompanhamento de Meta:\nMeta: R$ 300,00\nEconomizado: R$ 220,50\nFaltam: R$ 79,50\nVoc√™ est√° 5% acima do planejado! üèÜ");
        respostas.put("compare com m√™s passado", "üìä Comparativo Mensal:\nConsumo Atual: -15%\nGera√ß√£o Solar: +20%\nEconomia: +25%\nUso da Bateria: +10%\nVoc√™ est√° melhorando a cada m√™s! üåü");

        // Recomenda√ß√µes Personalizadas
        respostas.put("dicas de economia", "üí° Dicas Personalizadas:\n1. Use a m√°quina de lavar √†s 14h (pico solar)\n2. Configure o ar-condicionado para 23¬∞C\n3. Carregue dispositivos durante o dia\nSeguindo essas dicas, voc√™ pode economizar + R$ 45,00 esse m√™s!");
        respostas.put("melhor hor√°rio eletrodom√©sticos", "‚è∞ Hor√°rios Recomendados Hoje:\n9h-11h: M√°quina de Lavar\n13h-15h: Aspirador\n10h-16h: Ar Condicionado\n12h-14h: Forno El√©trico\nAproveite o pico de gera√ß√£o solar! ‚òÄÔ∏è");
        respostas.put("sugest√£o de uso da bateria", "üîã Recomenda√ß√£o de Uso:\nUse a bateria: 18h-21h\nRecarregue: 23h-5h\nEconomia estimada: R$ 18,50\nSua bateria est√° otimizada para seu padr√£o de consumo! ‚ö°");
        respostas.put("dicas do dia", "üåü Dicas de Hoje:\n1. Dia ensolarado: aproveite para lavar roupas\n2. Bateria est√° cheia: ideal para usar √† noite\n3. Tarifa alta √†s 18h: use a bateria\nSiga as dicas e economize + R$ 12,00 hoje!");

        // Manuten√ß√£o e Cuidados
        respostas.put("preciso de manuten√ß√£o", "üîß An√°lise de Manuten√ß√£o:\nPain√©is: OK (98% efici√™ncia)\nBateria: OK (95% sa√∫de)\nInversor: OK (97% efici√™ncia)\nPr√≥xima manuten√ß√£o preventiva: 15 dias\nSeu sistema est√° em √≥timo estado! ‚ú®");
        respostas.put("quando limpar pain√©is", "üßπ Recomenda√ß√£o de Limpeza:\n√öltima limpeza: 12 dias atr√°s\nEfici√™ncia atual: 96%\nPrevis√£o de chuva: Em 3 dias\nSugest√£o: Aguarde a chuva para avaliar necessidade de limpeza üëç");
        respostas.put("relat√≥rio de efici√™ncia", "üìã Relat√≥rio Completo:\nEfici√™ncia Geral: 95%\nPain√©is: 96%\nBateria: 94%\nInversor: 98%\nSeu sistema est√° entre os 10% mais eficientes! üèÜ");
        respostas.put("hist√≥rico de manuten√ß√£o", "üìö Hist√≥rico de Manuten√ß√µes:\n√öltima geral: 60 dias atr√°s\n√öltima limpeza: 12 dias\nPr√≥xima prevista: 20 dias\nTodas manuten√ß√µes em dia! ‚úÖ");

        // Economia e Sustentabilidade
        respostas.put("impacto ambiental", "üå± Seu Impacto Ambiental:\nCO2 evitado: 180kg\n√Årvores equivalentes: 15\nEconomia de √°gua: 1200L\nSua contribui√ß√£o para o planeta √© incr√≠vel! üåç");
        respostas.put("benef√≠cios ambientais", "üåø Benef√≠cios Ambientais:\nRedu√ß√£o de CO2: 180kg/m√™s\nEconomia de √°gua: 1200L/m√™s\nEnergia limpa gerada: 450 kWh/m√™s\nVoc√™ est√° fazendo a diferen√ßa! üíö");
        respostas.put("economia total", "üí∞ Economia Total:\nEste m√™s: R$ 280,50\nEste ano: R$ 2.850,00\nDesde a instala√ß√£o: R$ 8.500,00\nRetorno do investimento: 45% conclu√≠do üìà");
        respostas.put("retorno financeiro", "üíµ An√°lise de Retorno:\nInvestimento inicial: R$ 15.000\nEconomia total: R$ 8.500\nTempo restante: 2.5 anos\nSeu sistema est√° pagando-se mais r√°pido que o previsto! üéâ");

        // Ajuda e Suporte
        respostas.put("problemas comuns", "‚ùì Problemas Mais Comuns:\n1. Baixa gera√ß√£o: Verifique sombras/sujeira\n2. Bateria n√£o carrega: Verificar conex√µes\n3. App n√£o conecta: Reiniciar roteador\nPrecisa de ajuda com algum desses? üîß");
        respostas.put("contato suporte", "üìû Canais de Suporte:\nWhatsApp: (11) 99999-9999\nEmail: suporte@unisolar.com\nHor√°rio: 8h-20h\nTempos m√©dios de resposta: 5 minutos üë®‚Äçüíª");
        respostas.put("agendamento t√©cnico", "üë®‚Äçüîß Agendamento T√©cnico:\nPr√≥xima visita dispon√≠vel: 3 dias\nDura√ß√£o: 1-2 horas\nCusto: Dentro da garantia\nDeseja agendar uma visita?");

        // Manter algumas respostas originais importantes
        respostas.put("como economizar energia com o sistema solarIA", "Voc√™ pode economizar energia ajustando o uso de eletrodom√©sticos durante o dia, aproveitando a energia solar. O sistema tamb√©m otimiza o uso da bateria para garantir que voc√™ use a energia armazenada quando for mais vantajoso. üí°");
        respostas.put("como o sistema decide quando usar a energia da bateria e quando usar a rede el√©trica", "A IA avalia o consumo, a previs√£o do tempo e as tarifas de energia. Ela usa energia da bateria quando necess√°rio, e opta pela rede el√©trica em hor√°rios de tarifa mais baixa ou se a bateria estiver quase descarregada. ü§ñ");
        respostas.put("o que √© net metering", "O Net Metering √© um programa que permite que voc√™ envie a energia excedente gerada pelos seus pain√©is solares de volta para a rede el√©trica, gerando cr√©ditos que podem ser usados posteriormente para reduzir sua conta de energia. üíö");
    }

    public void startChat() {
        initializeResponses();
        System.out.println("\n=========== Chat com SolarIA ü§ñ ===========");
        System.out.println("SolarIA: ‚òÄÔ∏è Ol√°! Sou a SolarIA, assistente virtual da Unisolar! Como posso ajudar? üí°");
        System.out.println("Digite 'sair' para voltar ao menu principal ou 'ajuda' para ver comandos dispon√≠veis");

        while (true) {
            System.out.print("\nVoc√™: ");
            String question = scanner.nextLine().toLowerCase();

            if (question.equalsIgnoreCase("sair")) {
                break;
            }

            if (question.equalsIgnoreCase("ajuda")) {
                showHelp();
                continue;
            }

            String resposta = getResposta(question);
            if (resposta != null) {
                System.out.println("SolarIA: " + resposta);
            } else {
                System.out.println("SolarIA: Desculpe, n√£o entendi. Voc√™ pode reformular a pergunta? Digite 'ajuda' para ver os comandos dispon√≠veis. ü§î");
            }
        }
    }

    private void showHelp() {
        System.out.println("\nComandos dispon√≠veis:");
        System.out.println("- 'status atual': Ver o estado atual do sistema");
        System.out.println("- 'economia': Ver sua economia atual");
        System.out.println("- 'bateria': Ver status da bateria");
        System.out.println("- 'previs√£o': Ver previs√£o para amanh√£");
        System.out.println("- 'dicas': Receber dicas de economia");
        System.out.println("- 'manuten√ß√£o': Ver status de manuten√ß√£o");
        System.out.println("- 'suporte': Contatar suporte t√©cnico");
        System.out.println("- 'sair': Voltar ao menu principal");
    }

    private static String getResposta(String input) {
        // Remove acentos e normaliza o texto
        String normalizedInput = normalizeText(input.toLowerCase());

        for (Map.Entry<String, String> entry : respostas.entrySet()) {
            // Remove acentos e normaliza as chaves de resposta tamb√©m
            String normalizedKey = normalizeText(entry.getKey().toLowerCase());

            if (normalizedInput.contains(normalizedKey)) {
                return entry.getValue();
            }
        }
        return null;
    }

    private static String normalizeText(String text) {
        // Remove acentos e normaliza caracteres especiais
        String normalized = Normalizer.normalize(text, Normalizer.Form.NFD);
        return normalized.replaceAll("[^\\p{ASCII}]", "");
    }
}